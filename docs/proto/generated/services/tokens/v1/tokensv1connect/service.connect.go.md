# Documentaci贸n T茅cnica: proto/generated/services/tokens/v1/tokensv1connect/service.connect.go

## Descripci贸n General

Este archivo es **c贸digo generado autom谩ticamente** por `protoc-gen-connect-go` a partir del archivo `services/tokens/v1/service.proto`. Implementa las interfaces y clientes ConnectRPC para el servicio de gesti贸n de tokens de dispositivos m贸viles. A diferencia del servicio de chat que tiene m煤ltiples m茅todos, este servicio se enfoca espec铆ficamente en el registro y gesti贸n de tokens para notificaciones push.

## Estructura del Archivo

### Informaci贸n de Generaci贸n

```go
// Code generated by protoc-gen-connect-go. DO NOT EDIT.
//
// Source: services/tokens/v1/service.proto
```

**An谩lisis:**
- **Generaci贸n autom谩tica**: No debe editarse manualmente
- **Fuente**: Generado desde `services/tokens/v1/service.proto`
- **Herramienta**: `protoc-gen-connect-go` del ecosistema ConnectRPC

### Importaciones

```go
import (
    connect "connectrpc.com/connect"
    context "context"
    errors "errors"
    v1 "github.com/Venqis-NolaTech/campaing-app-chat-messages-api-go/proto/generated/services/tokens/v1"
    http "net/http"
    strings "strings"
)
```

**An谩lisis de Dependencias:**
- **`connect`**: Framework ConnectRPC para servicios gRPC-Web
- **`context`**: Manejo de contexto y cancelaci贸n
- **`errors`**: Creaci贸n de errores est谩ndar
- **`v1`**: Tipos de datos generados desde Protocol Buffers
- **`http`**: Servidor HTTP est谩ndar
- **`strings`**: Manipulaci贸n de strings para URLs

### Verificaci贸n de Compatibilidad

```go
const _ = connect.IsAtLeastVersion1_13_0
```

**Prop贸sito:**
- **Verificaci贸n en tiempo de compilaci贸n**: Asegura compatibilidad de versiones
- **Prevenci贸n de errores**: Evita incompatibilidades entre versiones
- **Versi贸n m铆nima**: Requiere ConnectRPC v1.13.0 o superior

## Constantes de Servicio

### Nombre del Servicio

```go
const (
    // TokensServiceName is the fully-qualified name of the TokensService service.
    TokensServiceName = "services.tokens.v1.TokensService"
)
```

**An谩lisis:**
- **Nombre completo**: Identificador 煤nico del servicio
- **Formato**: `package.service` siguiendo convenciones de Protocol Buffers
- **Uso**: Registro de servicios, m茅tricas, logging

### Procedimiento RPC

```go
const (
    // TokensServiceSaveTokenProcedure is the fully-qualified name of the TokensService's SaveToken RPC.
    TokensServiceSaveTokenProcedure = "/services.tokens.v1.TokensService/SaveToken"
)
```

**An谩lisis del Procedimiento:**

#### Formato del Procedimiento
- **Patr贸n**: `/package.service/Method`
- **Uso**: Ruta HTTP para gRPC-Web y Connect
- **Identificaci贸n**: Nombre 煤nico para la operaci贸n

#### Funcionalidad del M茅todo
- **Prop贸sito**: Registrar tokens de dispositivos para notificaciones push
- **Plataformas**: iOS (APNS), Android (FCM), Web (Web Push)
- **Autenticaci贸n**: Requiere token privado ()

## Interface TokensServiceClient

```go
type TokensServiceClient interface {
    //  Need private token to access this endpoint
    // - platform: IOS, ANDROID, WEB
    SaveToken(context.Context, *connect.Request[v1.SaveTokenRequest]) (*connect.Response[v1.SaveTokenResponse], error)
}
```

**An谩lisis de la Interface:**

### Caracter铆sticas del M茅todo SaveToken
- **Autenticaci贸n**: Requiere token privado ()
- **Plataformas soportadas**: IOS, ANDROID, WEB
- **Context-aware**: Recibe `context.Context` para cancelaci贸n
- **Type Safety**: Uso de generics para requests y responses tipados
- **Error Handling**: Retorno expl铆cito de errores

### Funcionalidad Espec铆fica
- **Registro de tokens**: Almacena tokens FCM/APNS/Web Push
- **Actualizaci贸n**: Permite actualizar tokens existentes
- **M煤ltiples dispositivos**: Un usuario puede tener m煤ltiples tokens
- **Metadatos**: Incluye informaci贸n del dispositivo y plataforma

## Funci贸n NewTokensServiceClient

```go
func NewTokensServiceClient(httpClient connect.HTTPClient, baseURL string, opts ...connect.ClientOption) TokensServiceClient {
    baseURL = strings.TrimRight(baseURL, "/")
    tokensServiceMethods := v1.File_services_tokens_v1_service_proto.Services().ByName("TokensService").Methods()
    return &tokensServiceClient{
        saveToken: connect.NewClient[v1.SaveTokenRequest, v1.SaveTokenResponse](
            httpClient,
            baseURL+TokensServiceSaveTokenProcedure,
            connect.WithSchema(tokensServiceMethods.ByName("SaveToken")),
            connect.WithClientOptions(opts...),
        ),
    }
}
```

**An谩lisis de la Funci贸n:**

### Par谩metros
- **`httpClient`**: Cliente HTTP para realizar requests
- **`baseURL`**: URL base del servidor (ej: `https://api.example.com`)
- **`opts`**: Opciones adicionales de configuraci贸n

### Proceso de Construcci贸n

#### 1. Normalizaci贸n de URL
```go
baseURL = strings.TrimRight(baseURL, "/")
```
- **Prop贸sito**: Elimina slash final para evitar URLs malformadas
- **Resultado**: URLs consistentes

#### 2. Obtenci贸n de Metadata
```go
tokensServiceMethods := v1.File_services_tokens_v1_service_proto.Services().ByName("TokensService").Methods()
```
- **Prop贸sito**: Obtiene metadata de m茅todos desde Protocol Buffers
- **Uso**: Configuraci贸n de schema para validaci贸n

#### 3. Creaci贸n del Cliente
```go
saveToken: connect.NewClient[v1.SaveTokenRequest, v1.SaveTokenResponse](
    httpClient,
    baseURL+TokensServiceSaveTokenProcedure,
    connect.WithSchema(tokensServiceMethods.ByName("SaveToken")),
    connect.WithClientOptions(opts...),
)
```

**Caracter铆sticas:**
- **Type Safety**: Generics para request/response tipados
- **URL Completa**: Combina baseURL con procedure
- **Schema**: Metadata para validaci贸n
- **Opciones**: Configuraci贸n personalizable

## Estructura tokensServiceClient

```go
type tokensServiceClient struct {
    saveToken *connect.Client[v1.SaveTokenRequest, v1.SaveTokenResponse]
}
```

**An谩lisis:**
- **Simplicidad**: Solo un cliente para el 煤nico m茅todo
- **Type Safety**: Cliente tipado espec铆ficamente
- **Reutilizaci贸n**: Cliente reutilizable para m煤ltiples calls

### Implementaci贸n del M茅todo

```go
func (c *tokensServiceClient) SaveToken(ctx context.Context, req *connect.Request[v1.SaveTokenRequest]) (*connect.Response[v1.SaveTokenResponse], error) {
    return c.saveToken.CallUnary(ctx, req)
}
```

**Patr贸n:**
- **Delegaci贸n**: Delega al cliente espec铆fico
- **CallUnary**: Para m茅todo request-response
- **Simplicidad**: Implementaci贸n directa sin l贸gica adicional

## Interface TokensServiceHandler

```go
type TokensServiceHandler interface {
    //  Need private token to access this endpoint
    // - platform: IOS, ANDROID, WEB
    SaveToken(context.Context, *connect.Request[v1.SaveTokenRequest]) (*connect.Response[v1.SaveTokenResponse], error)
}
```

**An谩lisis:**
- **Misma signature**: Id茅ntica al cliente para consistencia
- **Implementaci贸n del servidor**: Define lo que debe implementar el servidor
- **Documentaci贸n**: Incluye mismos comentarios sobre autenticaci贸n y plataformas

## Funci贸n NewTokensServiceHandler

```go
func NewTokensServiceHandler(svc TokensServiceHandler, opts ...connect.HandlerOption) (string, http.Handler) {
    tokensServiceMethods := v1.File_services_tokens_v1_service_proto.Services().ByName("TokensService").Methods()
    tokensServiceSaveTokenHandler := connect.NewUnaryHandler(
        TokensServiceSaveTokenProcedure,
        svc.SaveToken,
        connect.WithSchema(tokensServiceMethods.ByName("SaveToken")),
        connect.WithHandlerOptions(opts...),
    )
    return "/services.tokens.v1.TokensService/", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        switch r.URL.Path {
        case TokensServiceSaveTokenProcedure:
            tokensServiceSaveTokenHandler.ServeHTTP(w, r)
        default:
            http.NotFound(w, r)
        }
    })
}
```

**An谩lisis del Proceso:**

### 1. Creaci贸n del Handler
```go
tokensServiceSaveTokenHandler := connect.NewUnaryHandler(
    TokensServiceSaveTokenProcedure,
    svc.SaveToken,
    connect.WithSchema(tokensServiceMethods.ByName("SaveToken")),
    connect.WithHandlerOptions(opts...),
)
```
- **Unary Handler**: Para m茅todo request-response
- **Procedure**: Ruta espec铆fica del m茅todo
- **Implementation**: Funci贸n del servicio a ejecutar
- **Schema**: Metadata para validaci贸n

### 2. Router HTTP
```go
return "/services.tokens.v1.TokensService/", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    switch r.URL.Path {
    case TokensServiceSaveTokenProcedure:
        tokensServiceSaveTokenHandler.ServeHTTP(w, r)
    default:
        http.NotFound(w, r)
    }
})
```
- **Mount Path**: `"/services.tokens.v1.TokensService/"` para registro
- **Path Matching**: Switch simple con un solo caso
- **404**: Paths no reconocidos retornan Not Found

### 3. Simplicidad vs Chat Service
- **Un solo m茅todo**: Mucho m谩s simple que el servicio de chat
- **Switch m铆nimo**: Solo un case vs m煤ltiples en chat
- **Mantenimiento**: M谩s f谩cil de mantener y entender

## Estructura UnimplementedTokensServiceHandler

```go
type UnimplementedTokensServiceHandler struct{}

func (UnimplementedTokensServiceHandler) SaveToken(context.Context, *connect.Request[v1.SaveTokenRequest]) (*connect.Response[v1.SaveTokenResponse], error) {
    return nil, connect.NewError(connect.CodeUnimplemented, errors.New("services.tokens.v1.TokensService.SaveToken is not implemented"))
}
```

**Prop贸sito:**
- **Base Implementation**: Implementaci贸n base que retorna "no implementado"
- **Desarrollo Incremental**: Permite implementar m茅todos gradualmente
- **Testing**: til para testing de m茅todos espec铆ficos
- **Error Est谩ndar**: Retorna error gRPC est谩ndar `UNIMPLEMENTED`

## Protocolos Soportados

### 1. gRPC Nativo
- **Transport**: HTTP/2
- **Encoding**: Protocol Buffers binario
- **Uso**: Comunicaci贸n servidor-servidor

### 2. gRPC-Web
- **Transport**: HTTP/1.1 o HTTP/2
- **Encoding**: Protocol Buffers binario
- **Uso**: Navegadores web con proxy

### 3. Connect Protocol
- **Transport**: HTTP/1.1 o HTTP/2
- **Encoding**: JSON o Protocol Buffers
- **Uso**: APIs REST-like con type safety

## Mapeo HTTP

### Ruta del Servicio

Bas谩ndose en el descriptor, el m茅todo SaveToken se mapea a:

```
POST /api/tokens/v1/save
```

**Caracter铆sticas:**
- **HTTP Method**: POST (para operaciones de escritura)
- **Path**: `/api/tokens/v1/save`
- **Body**: Request completo en JSON o Protocol Buffers
- **Headers**: Autenticaci贸n requerida

## Casos de Uso

### 1. Registro de Token FCM (Android)

```go
client := tokensv1connect.NewTokensServiceClient(
    http.DefaultClient,
    "https://api.example.com",
)

request := &tokensv1.SaveTokenRequest{
    Token:           "fcm_token_abc123...",
    Platform:        "ANDROID",
    PlatformVersion: "14",
    Device:          "Samsung Galaxy S24",
    Lang:            "es",
    IsVoip:          false,
    Debug:           false,
}

response, err := client.SaveToken(ctx, connect.NewRequest(request))
if err != nil {
    log.Printf("Error: %v", err)
    return
}

if response.Msg.GetSuccess() {
    log.Println("Token registrado exitosamente")
}
```

### 2. Registro de Token APNS (iOS)

```go
request := &tokensv1.SaveTokenRequest{
    Token:           "apns_token_def456...",
    Platform:        "IOS",
    PlatformVersion: "17.2",
    Device:          "iPhone 15 Pro",
    TokenVoip:       "voip_token_789...",
    IsVoip:          true,
    Lang:            "en",
    Debug:           false,
}

response, err := client.SaveToken(ctx, connect.NewRequest(request))
```

### 3. Registro de Token Web Push

```go
request := &tokensv1.SaveTokenRequest{
    Token:           "web_push_token_ghi789...",
    Platform:        "WEB",
    PlatformVersion: "Chrome 120",
    Device:          "Desktop Chrome",
    Lang:            "fr",
    IsVoip:          false,
    Debug:           false,
}

response, err := client.SaveToken(ctx, connect.NewRequest(request))
```

## Configuraci贸n de Cliente

### Opciones Comunes

```go
client := tokensv1connect.NewTokensServiceClient(
    http.DefaultClient,
    "https://api.example.com",
    connect.WithGRPC(),                    // Usar protocolo gRPC
    connect.WithCompression("gzip"),       // Compresi贸n
    connect.WithClientOptions(
        connect.WithInterceptors(authInterceptor), // Middleware
    ),
)
```

### Interceptor de Autenticaci贸n

```go
func authInterceptor() connect.UnaryInterceptorFunc {
    return func(next connect.UnaryFunc) connect.UnaryFunc {
        return func(ctx context.Context, req connect.AnyRequest) (connect.AnyResponse, error) {
            req.Header().Set("Authorization", "Bearer "+token)
            return next(ctx, req)
        }
    }
}
```

## Testing

### Unit Tests

```go
func TestSaveToken(t *testing.T) {
    // Mock handler
    handler := &MockTokensServiceHandler{}
    handler.On("SaveToken", mock.Anything, mock.Anything).
        Return(&connect.Response[tokensv1.SaveTokenResponse]{
            Msg: &tokensv1.SaveTokenResponse{Success: true},
        }, nil)
    
    // Create test server
    _, httpHandler := tokensv1connect.NewTokensServiceHandler(handler)
    server := httptest.NewServer(httpHandler)
    defer server.Close()
    
    // Create client
    client := tokensv1connect.NewTokensServiceClient(
        http.DefaultClient,
        server.URL,
    )
    
    // Test request
    request := &tokensv1.SaveTokenRequest{
        Token:    "test_token",
        Platform: "ANDROID",
        Device:   "Test Device",
    }
    
    response, err := client.SaveToken(context.Background(), connect.NewRequest(request))
    
    assert.NoError(t, err)
    assert.True(t, response.Msg.GetSuccess())
    handler.AssertExpectations(t)
}
```

### Integration Tests

```go
func TestTokensServiceIntegration(t *testing.T) {
    // Setup real service
    service := &realTokensServiceHandler{
        repo: setupTestRepository(t),
    }
    
    _, httpHandler := tokensv1connect.NewTokensServiceHandler(service)
    server := httptest.NewServer(httpHandler)
    defer server.Close()
    
    client := tokensv1connect.NewTokensServiceClient(
        http.DefaultClient,
        server.URL,
    )
    
    // Test token registration
    request := &tokensv1.SaveTokenRequest{
        Token:           generateValidFCMToken(),
        Platform:        "ANDROID",
        PlatformVersion: "14",
        Device:          "Pixel 8",
        Lang:            "es",
    }
    
    response, err := client.SaveToken(context.Background(), connect.NewRequest(request))
    
    assert.NoError(t, err)
    assert.True(t, response.Msg.GetSuccess())
    
    // Verify token was saved
    // ... verification logic
}
```

## Comparaci贸n con Chat Service

### Similitudes
- **Misma estructura**: Patr贸n id茅ntico de generaci贸n
- **Mismas interfaces**: Client, Handler, Unimplemented
- **Mismos protocolos**: gRPC, gRPC-Web, Connect
- **Misma configuraci贸n**: Opciones y middleware

### Diferencias
- **Simplicidad**: Un solo m茅todo vs 23 m茅todos
- **Funcionalidad**: Espec铆fico vs general
- **Complejidad**: Router simple vs complejo
- **Mantenimiento**: M谩s f谩cil de mantener

## Mejores Pr谩cticas

1. **Reutilizaci贸n de cliente**: Crear una vez, usar m煤ltiples veces
2. **Manejo de errores**: Verificar errores espec铆ficos de ConnectRPC
3. **Context con timeout**: Siempre usar context con timeout apropiado
4. **Autenticaci贸n**: Implementar interceptor de autenticaci贸n
5. **Logging**: Agregar logging para debugging
6. **Rate limiting**: Implementar rate limiting para prevenir abuso

## Consideraciones de Seguridad

### Validaci贸n de Tokens
- **Formato**: Validar formato de tokens FCM/APNS
- **Longitud**: Verificar longitud apropiada
- **Caracteres**: Solo caracteres v谩lidos

### Rate Limiting
- **Por usuario**: Limitar registros por usuario
- **Por IP**: Limitar requests por IP
- **Por tiempo**: Ventanas de tiempo para prevenir spam

### Autenticaci贸n
- **Token requerido**: Siempre verificar autenticaci贸n
- **Permisos**: Verificar permisos del usuario
- **Expiraci贸n**: Manejar tokens expirados

Este archivo proporciona una interfaz simple pero completa para la gesti贸n de tokens de dispositivos, siguiendo los mismos patrones robustos del servicio de chat pero con una funcionalidad m谩s espec铆fica y enfocada.